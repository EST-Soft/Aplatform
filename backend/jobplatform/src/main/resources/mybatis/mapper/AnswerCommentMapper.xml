<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jobplatform.fo.board.mapper.AnswerCommentMapper">

    <!-- ResultMap 정의 -->
    <resultMap id="AnswerCommentResultMap" type="jobplatform.fo.board.entity.AnswerCommentEntity">
        <id property="cmntSq" column="cmnt_sq" />
        <result property="answrSq" column="answr_sq" />
        <result property="mbrSq" column="mbr_sq" />
        <result property="entrprsSq" column="entrprs_sq" />
        <result property="cmntCntnt" column="cmnt_cntnt" />
        <result property="insrtDtm" column="insrt_dtm" />
        <result property="updtDtm" column="updt_dtm" />
        <result property="dltDtm" column="dlt_dtm" />
        <result property="dltYn" column="dlt_yn" />
    </resultMap>

    <!-- 댓글 조회 -->
	<select id="selectCommentsByAnswerId" resultMap="AnswerCommentResultMap">
	    SELECT 
	        c.*,
	        COALESCE(m.mbr_id, e.entrprs_id) AS createdBy
	    FROM P5_TBL_ANSWER_COMMENT c
	    LEFT JOIN p3_tbl_member_m m ON c.mbr_sq = m.mbr_sq
	    LEFT JOIN p3_tbl_enterprise_member_m e ON c.entrprs_sq = e.entrprs_sq
	    WHERE c.answr_sq = #{answrSq} AND c.dlt_yn = 'N'
	    ORDER BY c.insrt_dtm ASC
	</select>

    <!-- 댓글 삽입 -->
    <insert id="insertComment">
        INSERT INTO P5_TBL_ANSWER_COMMENT (answr_sq, mbr_sq, entrprs_sq, cmnt_cntnt, insrt_dtm, dlt_yn)
        VALUES (#{answrSq}, #{mbrSq}, #{entrprsSq}, #{cmntCntnt}, NOW(), 'N')
    </insert>

    <!-- 댓글 수정 -->
    <update id="updateComment">
        UPDATE P5_TBL_ANSWER_COMMENT
        SET cmnt_cntnt = #{cmntCntnt}, updt_dtm = NOW()
        WHERE cmnt_sq = #{cmntSq} AND dlt_yn = 'N'
    </update>

    <!-- 댓글 논리 삭제 -->
    <update id="deleteComment">
        UPDATE P5_TBL_ANSWER_COMMENT
        SET dlt_yn = 'Y', dlt_dtm = NOW()
        WHERE cmnt_sq = #{cmntSq}
    </update>

</mapper>
